name: Deploy Contract

on:
    workflow_dispatch:
        inputs:
            network:
                description: "Network to deploy to"
                required: true
                default: "testnet"
                type: choice
                options:
                    - testnet
                    - mainnet
            contract_account:
                description: "Contract account ID (e.g., veritasai.obioma_360.tg)"
                required: true
                default: "obioma_360.tg"

jobs:
    build:
        name: Build Contract
        runs-on: ubuntu-latest

        steps:
            - name: Checkout repository
              uses: actions/checkout@v4

            - name: Setup Rust
              uses: dtolnay/rust-action@stable
              with:
                  targets: wasm32-unknown-unknown

            - name: Cache cargo
              uses: actions/cache@v4
              with:
                  path: |
                      ~/.cargo/registry
                      ~/.cargo/git
                      contracts/target
                  key: ${{ runner.os }}-cargo-${{ hashFiles('contracts/Cargo.lock') }}

            - name: Build contract
              working-directory: ./contracts
              run: |
                  cargo build --target wasm32-unknown-unknown --release
                  mkdir -p res
                  cp target/wasm32-unknown-unknown/release/veritasai_contract.wasm ./res/

            - name: Upload WASM artifact
              uses: actions/upload-artifact@v4
              with:
                  name: contract-wasm
                  path: contracts/res/veritasai_contract.wasm

    deploy:
        name: Deploy to ${{ github.event.inputs.network }}
        runs-on: ubuntu-latest
        needs: build
        environment: ${{ github.event.inputs.network }}

        steps:
            - name: Download WASM artifact
              uses: actions/download-artifact@v4
              with:
                  name: contract-wasm
                  path: ./res

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: "20"

            - name: Install NEAR CLI
              run: npm install -g near-cli

            - name: Configure NEAR credentials
              run: |
                  mkdir -p ~/.near-credentials/${{ github.event.inputs.network }}
                  echo '${{ secrets.NEAR_CREDENTIALS }}' > ~/.near-credentials/${{ github.event.inputs.network }}/${{ github.event.inputs.contract_account }}.json

            - name: Deploy contract
              env:
                  NEAR_ENV: ${{ github.event.inputs.network }}
              run: |
                  echo "Deploying to ${{ github.event.inputs.contract_account }} on ${{ github.event.inputs.network }}..."
                  near deploy ${{ github.event.inputs.contract_account }} ./res/veritasai_contract.wasm

            - name: Initialize contract (if new deployment)
              if: ${{ github.event.inputs.network == 'testnet' }}
              env:
                  NEAR_ENV: ${{ github.event.inputs.network }}
              run: |
                  echo "Initializing contract..."
                  near call ${{ github.event.inputs.contract_account }} new '{"owner": "${{ github.event.inputs.contract_account }}"}' --accountId ${{ github.event.inputs.contract_account }} || echo "Contract may already be initialized"

            - name: Verify deployment
              env:
                  NEAR_ENV: ${{ github.event.inputs.network }}
              run: |
                  echo "Verifying deployment..."
                  near view ${{ github.event.inputs.contract_account }} get_marketplace_fee '{}'
                  echo "âœ… Contract deployed successfully!"
